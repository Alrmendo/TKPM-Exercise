<header class="bg-blue-600 text-white py-4 shadow-md">
    <div class="w-[95%] mx-auto px-4">
        <h1 class="text-2xl font-bold">Quản Lý Danh Sách Sinh Viên</h1>
    </div>
</header>

<main class="w-[95%] mx-auto px-1 py-6">
    <!-- Form thêm sinh viên -->
    <section class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-lg font-bold mb-4">Thêm Sinh Viên Mới</h2>
        <form id="add-student-form" class="grid grid-cols-1 text-[15px] md:grid-cols-2 gap-4">
            <div>
                <label for="student-id" class="block font-medium">Mã số sinh viên</label>
                <input type="text" id="student-id" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label for="student-name" class="block font-medium">Họ tên</label>
                <input type="text" id="student-name" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label for="student-birthdate" class="block font-medium">Ngày tháng năm sinh</label>
                <input type="date" id="student-birthdate" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div>
                <label for="student-gender" class="block font-medium">Giới tính</label>
                <select id="student-gender" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="">Chọn</option>
                    <option value="Nam">Nam</option>
                    <option value="Nữ">Nữ</option>
                </select>
            </div>
            <div>
                <label for="student-department" class="block font-medium">Khoa</label>
                <select id="student-department" class="w-full border border-gray-300 rounded px-3 py-2" required>
                    <option value="">Chọn</option>
                    <option value="Khoa Luật">Khoa Luật</option>
                    <option value="Khoa Tiếng Anh thương mại">Khoa Tiếng Anh thương mại</option>
                    <option value="Khoa Tiếng Nhật">Khoa Tiếng Nhật</option>
                    <option value="Khoa Tiếng Pháp">Khoa Tiếng Pháp</option>
                </select>
            </div>
            <div>
                <label for="student-status" class="block font-medium">Tình trạng sinh viên</label>
                <select id="student-status" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="">Chọn</option>
                    <option value="Đang học">Đang học</option>
                    <option value="Đã tốt nghiệp">Đã tốt nghiệp</option>
                    <option value="Đã thôi học">Đã thôi học</option>
                    <option value="Tạm dừng học">Tạm dừng học</option>
                </select>
            </div>
            <div>
                <label for="student-email" class="block font-medium">Email</label>
                <input type="email" id="student-email" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label for="student-phone" class="block font-medium">Số điện thoại</label>
                <input type="tel" id="student-phone" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div>
                <label for="student-course" class="block font-medium">Khoá</label>
                <input type="text" id="student-course" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: K22" required>
            </div>
            <div>
                <label for="student-program" class="block font-medium">Chương trình</label>
                <input type="text" id="student-program" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: Chất lượng cao" required>
            </div>
            <div class="md:col-span-2">
                <label for="student-address" class="block font-medium">Địa chỉ</label>
                <input type="text" id="student-address" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div class="md:col-span-2 text-right">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Thêm</button>
            </div>
        </form>
    </section>

    <!-- Tìm kiếm sinh viên -->
    <section class="bg-white p-6 rounded shadow-md mb-6">
        <h2 class="text-lg font-bold mb-4">Tìm Kiếm Sinh Viên</h2>
        <h3 class="text-[14px]">Sẽ hiện ở dưới danh sách sinh viên. Nên có 2 sinh viên để hiểu được rõ hơn</h3>
        <input type="text" id="search-input" class="w-full border border-gray-300 rounded px-3 py-2 mb-4"
            placeholder="Nhập MSSV hoặc Họ Tên...">
    </section>

    <!-- Danh sách sinh viên -->
    <section class="bg-white p-6 rounded shadow-md">
        <h2 class="text-lg font-bold mb-4">Danh Sách Sinh Viên</h2>
        <div id="student-list" class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 text-left text-[15px]">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-3 py-2">MSSV</th>
                        <th class="border px-3 py-2">Họ Tên</th>
                        <th class="border px-3 py-2">Ngày Sinh</th>
                        <th class="border px-3 py-2">Giới Tính</th>
                        <th class="border px-3 py-2">Khoa</th>
                        <th class="border px-3 py-2">Tình Trạng</th>
                        <th class="border px-3 py-2">Email</th>
                        <th class="border px-3 py-2">SĐT</th>
                        <th class="border px-3 py-2">Khóa</th>
                        <th class="border px-3 py-2">Chương Trình</th>
                        <th class="border px-3 py-2">Địa Chỉ</th>
                        <th class="border px-3 py-2">Chỉnh sửa</th>
                    </tr>
                </thead>
                <tbody id="student-table-body">
                    <!-- Dữ liệu sinh viên -->
                </tbody>
            </table>
        </div>
    </section>

</main>

<!-- chỉnh sửa sinh viên -->
<div id="edit-modal" class="flex hidden fixed inset-0 bg-gray-800 bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded shadow-lg p-6 w-full max-w-4xl">
        <h3 class="text-xl font-bold mb-4">Chỉnh sửa thông tin sinh viên</h3>
        <form id="edit-student-form" class="grid grid-cols-2 gap-4">
            <!-- Mã số sinh viên -->
            <div>
                <label for="edit-student-id" class="block font-medium">Mã số sinh viên</label>
                <input type="text" id="edit-student-id" class="w-full border border-gray-300 rounded px-3 py-2"
                    required>
            </div>

            <!-- Họ tên -->
            <div>
                <label for="edit-student-name" class="block font-medium">Họ tên</label>
                <input type="text" id="edit-student-name" class="w-full border border-gray-300 rounded px-3 py-2"
                    required>
            </div>

            <!-- Ngày tháng năm sinh -->
            <div>
                <label for="edit-student-birthdate" class="block font-medium">Ngày tháng năm sinh</label>
                <input type="date" id="edit-student-birthdate" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>

            <!-- Giới tính -->
            <div>
                <label for="edit-student-gender" class="block font-medium">Giới tính</label>
                <select id="edit-student-gender" class="w-full border border-gray-300 rounded px-3 py-2" required>
                    <option value="">Chọn</option>
                    <option value="Nam">Nam</option>
                    <option value="Nữ">Nữ</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <!-- Khoa -->
            <div>
                <label for="edit-student-department" class="block font-medium">Khoa</label>
                <select id="edit-student-department" class="w-full border border-gray-300 rounded px-3 py-2" required>
                    <option value="">Chọn</option>
                    <option value="Khoa Luật">Khoa Luật</option>
                    <option value="Khoa Tiếng Anh thương mại">Khoa Tiếng Anh thương mại</option>
                    <option value="Khoa Tiếng Nhật">Khoa Tiếng Nhật</option>
                    <option value="Khoa Tiếng Pháp">Khoa Tiếng Pháp</option>
                </select>
            </div>

            <!-- Tình trạng -->
            <div>
                <label for="edit-student-status" class="block font-medium">Tình trạng sinh viên</label>
                <select id="edit-student-status" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="">Chọn</option>
                    <option value="Đang học">Đang học</option>
                    <option value="Đã tốt nghiệp">Đã tốt nghiệp</option>
                    <option value="Đã thôi học">Đã thôi học</option>
                    <option value="Tạm dừng học">Tạm dừng học</option>
                </select>
            </div>

            <!-- Email -->
            <div>
                <label for="edit-student-email" class="block font-medium">Email</label>
                <input type="email" id="edit-student-email" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: student@example.com" required>
            </div>

            <!-- Số điện thoại -->
            <div>
                <label for="edit-student-phone" class="block font-medium">Số điện thoại</label>
                <input type="tel" id="edit-student-phone" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: 0901234567" required>
            </div>

            <!-- Khóa -->
            <div>
                <label for="edit-student-course" class="block font-medium">Khóa</label>
                <input type="text" id="edit-student-course" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: K22">
            </div>

            <!-- Chương trình -->
            <div>
                <label for="edit-student-program" class="block font-medium">Chương trình</label>
                <input type="text" id="edit-student-program" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="VD: Chất lượng cao">
            </div>

            <!-- Địa chỉ -->
            <div class="col-span-2">
                <label for="edit-student-address" class="block font-medium">Địa chỉ</label>
                <input type="text" id="edit-student-address" class="w-full border border-gray-300 rounded px-3 py-2"
                    placeholder="Nhập địa chỉ sinh viên">
            </div>

            <div class="col-span-2 flex justify-end space-x-2">
                <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                    id="cancel-edit">Hủy</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Cập nhật
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const tableBody = document.getElementById('student-table-body');
    const searchInput = document.getElementById('search-input');

    // Lưu dữ liệu vào Local Storage (đã sửa để lưu đầy đủ các thông tin từ form)
    function saveToLocalStorage() {
        const rows = Array.from(tableBody.children).map(row => ({
            id: row.children[0].textContent,
            name: row.children[1].textContent,
            birthdate: row.children[2].textContent,
            gender: row.children[3].textContent,
            department: row.children[4].textContent,
            status: row.children[5].textContent,
            email: row.children[6].textContent,
            phone: row.children[7].textContent,
            course: row.children[8].textContent,
            program: row.children[9].textContent,
            address: row.children[10].textContent,
        }));
        localStorage.setItem('students', JSON.stringify(rows));
    }

    // Load từ Local Storage
    function loadFromLocalStorage() {
        const storedData = localStorage.getItem('students');
        if (storedData) {
            const students = JSON.parse(storedData);
            students.forEach(student => addStudentRow(student));
        }
    }

    // Thêm sinh viên vào bảng
    function addStudentRow(student) {
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
                <td class="text-[13px] border px-3 py-2">${student.id}</td>
                <td class="text-[13px] border px-3 py-2">${student.name}</td>
                <td class="text-[13px] border px-3 py-2">${student.birthdate}</td>
                <td class="text-[13px] border px-3 py-2">${student.gender}</td>
                <td class="text-[13px] border px-3 py-2">${student.department}</td>
                <td class="text-[13px] border px-3 py-2">${student.status}</td>
                <td class="text-[13px] border px-3 py-2">${student.email}</td>
                <td class="text-[13px] border px-3 py-2">${student.phone}</td>
                <td class="text-[13px] border px-3 py-2">${student.course}</td>
                <td class="text-[13px] border px-3 py-2">${student.program}</td>
                <td class="text-[13px] border px-3 py-2">${student.address}</td>
                <td class="text-[13px] border px-3 py-2 text-center" style="width: 107px;">
                    <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" onclick="editStudentRow(this)">Sửa</button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" onclick="deleteStudentRow(this)">Xóa</button>
                </td>
            `;

        tableBody.appendChild(newRow);
    }

    // Xóa sinh viên khỏi bảng
    function deleteStudentRow(button) {
        button.parentElement.parentElement.remove();
        saveToLocalStorage();
    }

    // Mở modal chỉnh sửa
    function editStudentRow(button) {
        const row = button.parentElement.parentElement;

        // Lấy dữ liệu từ dòng của bảng
        const studentId = row.children[0].textContent;
        const studentName = row.children[1].textContent;
        const studentBirthdate = row.children[2].textContent;
        const studentGender = row.children[3].textContent;
        const studentDepartment = row.children[4].textContent;
        const studentStatus = row.children[5].textContent;
        const studentEmail = row.children[6].textContent;
        const studentPhone = row.children[7].textContent;
        const studentCourse = row.children[8].textContent;
        const studentProgram = row.children[9].textContent;
        const studentAddress = row.children[10].textContent;

        // Gán dữ liệu vào các trường trong modal
        document.getElementById('edit-student-id').value = studentId;
        document.getElementById('edit-student-id').setAttribute('data-old-id', studentId);
        document.getElementById('edit-student-name').value = studentName;
        document.getElementById('edit-student-birthdate').value = studentBirthdate;
        document.getElementById('edit-student-gender').value = studentGender;
        document.getElementById('edit-student-department').value = studentDepartment;
        document.getElementById('edit-student-status').value = studentStatus;
        document.getElementById('edit-student-email').value = studentEmail;
        document.getElementById('edit-student-phone').value = studentPhone;
        document.getElementById('edit-student-course').value = studentCourse;
        document.getElementById('edit-student-program').value = studentProgram;
        document.getElementById('edit-student-address').value = studentAddress;

        const modal = document.getElementById('edit-modal');
        modal.classList.remove('hidden');
    }

    document.getElementById('cancel-edit').addEventListener('click', function () {
        document.getElementById('edit-modal').classList.add('hidden');
    });

    // Cập nhật dữ liệu sau khi chỉnh sửa
    document.getElementById('edit-student-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const oldStudentId = document.getElementById('edit-student-id').getAttribute('data-old-id');
        const newStudentId = document.getElementById('edit-student-id').value.trim();
        const studentName = document.getElementById('edit-student-name').value.trim();
        const studentBirthdate = document.getElementById('edit-student-birthdate').value.trim();
        const studentGender = document.getElementById('edit-student-gender').value;
        const studentDepartment = document.getElementById('edit-student-department').value;
        const studentStatus = document.getElementById('edit-student-status').value;
        const studentEmail = document.getElementById('edit-student-email').value.trim();
        const studentPhone = document.getElementById('edit-student-phone').value.trim();
        const studentCourse = document.getElementById('edit-student-course').value.trim();
        const studentProgram = document.getElementById('edit-student-program').value.trim();
        const studentAddress = document.getElementById('edit-student-address').value.trim();

        let students = JSON.parse(localStorage.getItem('students')) || [];

        // Kiểm tra trùng MSSV (ngoại trừ MSSV cũ)
        const isDuplicate = students.some(student => student.id === newStudentId && student.id !== oldStudentId);
        if (isDuplicate) {
            alert('Mã số sinh viên đã tồn tại! Vui lòng nhập lại.');
            return;
        }

        // Kiểm tra tính hợp lệ của Email
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(studentEmail)) {
            alert('Email không hợp lệ! Vui lòng nhập lại.');
            return;
        }

        // Kiểm tra tính hợp lệ của Số điện thoại (chỉ chứa số, 9-11 chữ số)
        const phoneRegex = /^[0-9]{9,11}$/;
        if (studentPhone && !phoneRegex.test(studentPhone)) {
            alert('Số điện thoại không hợp lệ! Vui lòng nhập số từ 9-11 chữ số.');
            return;
        }

        Array.from(tableBody.children).forEach(row => {
            if (row.children[0].textContent === oldStudentId) {
                row.children[0].textContent = newStudentId;
                row.children[1].textContent = studentName;
                row.children[2].textContent = studentBirthdate;
                row.children[3].textContent = studentGender;
                row.children[4].textContent = studentDepartment;
                row.children[5].textContent = studentStatus;
                row.children[6].textContent = studentEmail;
                row.children[7].textContent = studentPhone;
                row.children[8].textContent = studentCourse;
                row.children[9].textContent = studentProgram;
                row.children[10].textContent = studentAddress;
            }
        });

        students = students.map(student => {
            if (student.id === oldStudentId) {
                return {
                    id: newStudentId,
                    name: studentName,
                    birthdate: studentBirthdate,
                    gender: studentGender,
                    department: studentDepartment,
                    status: studentStatus,
                    email: studentEmail,
                    phone: studentPhone,
                    course: studentCourse,
                    program: studentProgram,
                    address: studentAddress,
                };
            }
            return student;
        });

        localStorage.setItem('students', JSON.stringify(students));
        document.getElementById('edit-modal').classList.add('hidden');
    });

    // Tìm kiếm sinh viên
    searchInput.addEventListener('input', function () {
        const filter = searchInput.value.toLowerCase();
        Array.from(tableBody.children).forEach(row => {
            const studentId = row.children[0].textContent.toLowerCase();
            const studentName = row.children[1].textContent.toLowerCase();
            if (studentId.includes(filter) || studentName.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Thêm sinh viên
    document.getElementById('add-student-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const studentID = document.getElementById('student-id').value.trim();
        const studentName = document.getElementById('student-name').value.trim();
        const studentBirthdate = document.getElementById('student-birthdate').value.trim();
        const studentGender = document.getElementById('student-gender').value;
        const studentDepartment = document.getElementById('student-department').value;
        const studentStatus = document.getElementById('student-status').value;
        const studentEmail = document.getElementById('student-email').value.trim();
        const studentPhone = document.getElementById('student-phone').value.trim();
        const studentCourse = document.getElementById('student-course').value.trim();
        const studentProgram = document.getElementById('student-program').value.trim();
        const studentAddress = document.getElementById('student-address').value.trim();

        const students = JSON.parse(localStorage.getItem('students')) || [];

        // Kiểm tra trùng MSSV
        const isDuplicate = students.some(student => student.id === studentID);
        if (isDuplicate) {
            alert('Mã số sinh viên đã tồn tại! Vui lòng nhập lại.');
            return;
        }

        // Kiểm tra tính hợp lệ của Email
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(studentEmail)) {
            alert('Email không hợp lệ! Vui lòng nhập lại.');
            return;
        }

        // Kiểm tra tính hợp lệ của Số điện thoại (chỉ chứa số, 9-11 chữ số)
        const phoneRegex = /^[0-9]{9,11}$/;
        if (studentPhone && !phoneRegex.test(studentPhone)) {
            alert('Số điện thoại không hợp lệ! Vui lòng nhập số từ 9-11 chữ số.');
            return;
        }

        const newStudent = {
            id: studentID,
            name: studentName,
            birthdate: studentBirthdate,
            gender: studentGender,
            department: studentDepartment,
            status: studentStatus,
            email: studentEmail,
            phone: studentPhone,
            course: studentCourse,
            program: studentProgram,
            address: studentAddress,
        };

        addStudentRow(newStudent);
        students.push(newStudent);
        localStorage.setItem('students', JSON.stringify(students));
        document.getElementById('add-student-form').reset();
    });


    loadFromLocalStorage();

</script>